<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Moji Redirect (safe full sentence)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script>
(function () {
  // 取 query/hash 参数，兼容多种占位符
  const qs = new URLSearchParams(location.search || "");
  function getFromHash() {
    const h = location.hash ? decodeURIComponent(location.hash.slice(1)) : "";
    if (!h) return "";
    const m = h.match(/^(?:k|kw|keyword|text|selection)=(.*)$/i);
    return (m ? m[1] : h).trim();
  }
  let raw = (qs.get('k') || qs.get('keyword') || qs.get('text') || qs.get('selection') || "").trim();
  if (!raw) raw = getFromHash();

  // 支持 ?debug=1 或 #...&debug=1
  const debug = (qs.get('debug') === '1') || /(?:^|[&#?])debug=1(?:&|$)/.test(location.hash);

  // 清洗函数：去控制符/折叠空白/标准化
  function sanitize(s) {
    if (!s) return "";
    // 去掉控制字符（包括零宽字符、回车等），保留常见标点
    s = s.replace(/[\u0000-\u001F\u007F-\u009F\u200B-\u200D\uFEFF]/g, " ");
    // 将各种空白（含换行/制表）折叠为单空格
    s = s.replace(/\s+/g, " ");
    // 去首尾空白
    s = s.trim();
    return s;
  }

  const cleaned = sanitize(raw);

  if (debug) {
    document.body.innerHTML =
      '<pre style="white-space:pre-wrap;padding:16px">' +
      'raw:\n' + raw + '\n\n' +
      'cleaned:\n' + cleaned + '\n\n' +
      'encoded:\n' + encodeURIComponent(cleaned) + '\n' +
      '</pre>';
    return;
  }

  if (!cleaned) {
    document.body.innerHTML = '<h2>No search term provided</h2><p>Use ?k=猫 或 #k=猫 测试；或加 &debug=1 查看传参。</p>';
    return;
  }

  // 严格编码整句，走 /searchText/ 更稳
  const target = 'https://www.mojidict.com/searchText/' + encodeURIComponent(cleaned) + '?app=desktop&from=mn4';
  location.replace(target);
})();
</script>
</head>
<body></body>
</html>
